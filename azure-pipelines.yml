trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageName: 'frontend-dummy'
  branchName: $(Build.SourceBranchName)
  imageTag: '$(Build.SourceBranchName)-$(Build.BuildId)-$(Date:yyyyMMdd)$(Rev:.r)'

steps:
- checkout: self

- script: |
    echo "Sanitizing branch name"
    echo "##vso[task.setvariable variable=cleanBranchName]$(echo $(branchName) | sed 's/\//-/g')"
  displayName: Sanitize branch name

- task: Docker@2
  displayName: Build Docker image
  inputs:
    containerRegistry: 'dw-acr-connection'
    command: build
    repository: $(imageName)
    Dockerfile: '**/Dockerfile'
    tags: |
      $(cleanBranchName)-$(Build.BuildId)-$(Date:yyyyMMdd)$(Rev:.r)

- task: Docker@2
  displayName: Push Docker image to ACR
  inputs:
    containerRegistry: 'dw-acr-connection'
    command: push
    repository: $(imageName)
    tags: |
      $(cleanBranchName)-$(Build.BuildId)-$(Date:yyyyMMdd)$(Rev:.r)
